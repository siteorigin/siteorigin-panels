(function($,_,panelsOptions){var panels=window.siteoriginPanels;panels.view.liveEditor=Backbone.View.extend({template:_.template($("#siteorigin-panels-live-editor").html().panelsProcessTemplate()),sectionTemplate:_.template($("#siteorigin-panels-live-editor-sidebar-section").html().panelsProcessTemplate()),postId:false,bodyScrollTop:null,displayed:false,events:{"click .live-editor-close":"close"},frameScrollTop:0,initialize:function(){},render:function(){this.setElement(this.template());this.$el.html(this.template());var thisView=this;this.$("iframe#siteorigin-panels-live-editor-iframe").load(function(){$(this).show();var ifc=$(this).contents();ifc.find(".panel-grid .panel-grid-cell .panel.widget").filter(function(){return $(this).parents(".widget_siteorigin-panels-builder").length==0}).each(function(i,el){var $$=$(el);var widgetEdit=thisView.$(".page-widgets .so-widget").eq(i);var overlay;$$.css({cursor:"pointer"}).mouseenter(function(){widgetEdit.addClass("so-hovered");overlay=thisView.createPreviewOverlay($(this))}).mouseleave(function(){widgetEdit.removeClass("so-hovered");overlay.fadeOut("fast",function(){$(this).remove()})}).click(function(e){e.preventDefault();widgetEdit.click()})});ifc.find("a").css({"pointer-events":"none"}).click(function(e){return false})})},attach:function(){this.$el.appendTo("body")},setPostId:function(postId){this.postId=postId},open:function(){if(this.$el.html()===""){this.render()}if(this.$el.closest("body").length===0){this.attach()}this.refreshWidgets();this.$el.show();this.refreshPreview();this.bodyScrollTop=$("body").scrollTop();$("body").css({overflow:"hidden"});this.displayed=true},close:function(){this.$el.hide();$("body").css({overflow:"auto"});$("body").scrollTop(this.bodyScrollTop);this.displayed=false;return false},refreshPreview:function(){if(!this.$el.is(":visible")){return false}this.$("iframe#siteorigin-panels-live-editor-iframe").hide();this.frameScrollTop=this.$("iframe#siteorigin-panels-live-editor-iframe").contents().find("body").scrollTop();this.$('form.live-editor-form input[name="siteorigin_panels_data"]').val(JSON.stringify(this.builder.model.getPanelsData()));this.$("form.live-editor-form").submit()},createPreviewOverlay:function(over){var previewFrame=this.$("iframe#siteorigin-panels-live-editor-iframe");var body=previewFrame.contents().find("body").css("position","relative");previewFrame.contents().find(".panels-live-editor-overlay").remove();var overlayContainer=$("<div />").addClass("panels-live-editor-overlay").css({"pointer-events":"none"});var overlay=$("<div />").css({position:"absolute",background:"#000000","z-index":1e4,opacity:.25});var spacing=15;overlayContainer.append(overlay.clone().css({top:-body.offset().top,left:0,right:0,height:over.offset().top-spacing})).append(overlay.clone().css({bottom:0,left:0,right:0,height:Math.round(body.height()-over.offset().top-over.outerHeight()-spacing+body.offset().top-.01)})).append(overlay.clone().css({top:over.offset().top-spacing-body.offset().top,left:0,width:over.offset().left-spacing,height:Math.ceil(over.outerHeight()+spacing*2)})).append(overlay.clone().css({top:over.offset().top-spacing-body.offset().top,right:0,left:over.offset().left+over.outerWidth()+spacing,height:Math.ceil(over.outerHeight()+spacing*2)}));previewFrame.contents().find("body").append(overlayContainer);return overlayContainer},refreshWidgets:function(){this.$(".so-sidebar .page-widgets").empty();var previewFrame=this.$("iframe#siteorigin-panels-live-editor-iframe");var thisView=this;var widgetIndex=0;this.builder.$(".so-row-container").each(function(ri,el){var row=$(el);var widgets=row.find(".so-cells .cell .so-widget");var sectionWrapper=$(thisView.sectionTemplate({title:"Row "+(ri+1)})).appendTo(thisView.$(".so-sidebar .page-widgets"));sectionWrapper.find(".section-header").click(function(){row.data("view").editSettingsHandler()});var widgetsWrapper=sectionWrapper.find(".section-widgets");widgets.each(function(i,el){var widget=$(this);var widgetClone=widget.clone().show().css({opacity:1});widgetClone.find(".actions").remove();widgetClone.find(".widget-icon").remove();var thisWidgetIndex=widgetIndex++;var getHoverWidget=function(){return previewFrame.contents().find("#pl-"+thisView.postId+" .panel-grid .panel-grid-cell .panel").filter(function(){return $(this).parents(".widget_siteorigin-panels-builder").length===0}).not("panel-hover-widget").eq(thisWidgetIndex)};var overlay=null,hoverWidget=null;widgetClone.click(function(e){e.preventDefault();widget.data("view").editHandler();return false}).mouseenter(function(){var hoverWidget=getHoverWidget();previewFrame.contents().find("html,body").clearQueue().animate({scrollTop:hoverWidget.offset().top-Math.max(30,(Math.min(previewFrame.contents().height(),previewFrame.height())-hoverWidget.outerHeight())/2)},750);overlay=thisView.createPreviewOverlay(hoverWidget)}).mouseleave(function(){previewFrame.contents().find("html,body").clearQueue();if(overlay!==null){overlay.fadeOut("fast",function(){$(this).remove()});overlay=null}if(hoverWidget!==null){hoverWidget.remove();hoverWidget=null}}).appendTo(widgetsWrapper)})})},hasPreviewUrl:function(){return this.$("form.live-editor-form").attr("action")!==""}})})(jQuery,_,soPanelsOptions);