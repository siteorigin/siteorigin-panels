String.prototype.panelsProcessTemplate=function(){var s=this;s=s.replace(/{{%/g,"<%");s=s.replace(/%}}/g,"%>");s=s.trim();return s};(function($,_,panelsOptions){var panels={model:{},collection:{},view:{},dialog:{},fn:{}};panels.model.widget=Backbone.Model.extend({cell:null,defaults:{"class":null,missing:false,values:{},raw:false,styles:{}},getWidgetField:function(field){if(typeof panelsOptions.widgets[this.get("class")]==="undefined"){if(field==="title"||field==="description"){return panelsOptions.loc.missing_widget[field]}else{return""}}else{return panelsOptions.widgets[this.get("class")][field]}},moveToCell:function(newCell){if(this.cell.cid===newCell.cid){return false}this.cell=newCell;this.collection.remove(this,{silent:true});newCell.widgets.add(this,{silent:true})},triggerEdit:function(){this.trigger("user_edit",this)},triggerDuplicate:function(){this.trigger("user_duplicate",this)},setValues:function(values){var hasChanged=false;if(JSON.stringify(values)!==JSON.stringify(this.get("values"))){hasChanged=true}this.set("values",values,{silent:true});if(hasChanged){this.trigger("change");this.trigger("change:values")}},clone:function(cell,options){if(typeof cell==="undefined"){cell=this.cell}var clone=new this.constructor(this.attributes);var cloneValues=JSON.parse(JSON.stringify(this.get("values")));var cleanClone=function(vals){_.each(vals,function(el,i){if(typeof i==="string"&&i[0]==="_"){delete vals[i]}else if(_.isObject(vals[i])){cleanClone(vals[i])}});return vals};cloneValues=cleanClone(cloneValues);if(this.get("class")==="SiteOrigin_Panels_Widgets_Layout"){cloneValues.builder_id=Math.random().toString(36).substr(2)}clone.set("values",cloneValues,{silent:true});clone.set("collection",cell.widgets,{silent:true});clone.cell=cell;clone.isDuplicate=true;return clone},getTitle:function(){var widgetData=panelsOptions.widgets[this.get("class")];if(typeof widgetData==="undefined"){return this.get("class").replace(/_/g," ")}else if(typeof widgetData.panels_title!=="undefined"){if(widgetData.panels_title===false){return panelsOptions.widgets[this.get("class")].description}}var values=this.get("values");var thisModel=this;var titleFields=["title","text"];for(var k in values){titleFields.push(k)}titleFields=_.uniq(titleFields);for(var i in titleFields){if(typeof values[titleFields[i]]!=="undefined"&&typeof values[titleFields[i]]==="string"&&values[titleFields[i]]!==""&&!$.isNumeric(values[titleFields[i]])){var title=values[titleFields[i]];title=title.replace(/<\/?[^>]+(>|$)/g,"");var parts=title.split(" ");parts=parts.slice(0,20);return parts.join(" ")}}return this.getWidgetField("description")}});panels.view.widget=Backbone.View.extend({template:_.template($("#siteorigin-panels-builder-widget").html().panelsProcessTemplate()),cell:null,dialog:null,events:{"click .widget-edit":"editHandler","click .title h4":"editHandler","click .actions .widget-duplicate":"duplicateHandler","click .actions .widget-delete":"deleteHandler"},initialize:function(){this.model.on("user_edit",this.editHandler,this);this.model.on("user_duplicate",this.duplicateHandler,this);this.model.on("destroy",this.onModelDestroy,this);this.model.on("visual_destroy",this.visualDestroyModel,this);this.model.on("change:values",this.onModelChange,this)},render:function(options){options=_.extend({loadForm:false},options);this.setElement(this.template({title:this.model.getWidgetField("title"),description:this.model.getTitle()}));this.$el.data("view",this);if(_.size(this.model.get("values"))===0||options.loadForm){var dialog=this.getEditDialog();dialog.once("form_loaded",dialog.saveWidget,dialog);dialog.setupDialog()}},visualCreate:function(){this.$el.hide().fadeIn("fast")},getEditDialog:function(){if(this.dialog===null){this.dialog=new panels.dialog.widget({model:this.model});this.dialog.setBuilder(this.cell.row.builder);this.dialog.widgetView=this}return this.dialog},editHandler:function(){this.getEditDialog().openDialog();return false},duplicateHandler:function(){this.cell.row.builder.addHistoryEntry("widget_duplicated");var newWidget=this.model.clone(this.model.cell);this.cell.model.widgets.add(newWidget,{at:this.model.collection.indexOf(this.model)+1});return false},deleteHandler:function(){this.model.trigger("visual_destroy");return false},onModelChange:function(){this.$(".description").html(this.model.getTitle())},onModelDestroy:function(){this.remove()},visualDestroyModel:function(){this.cell.row.builder.addHistoryEntry("widget_deleted");var thisView=this;this.$el.fadeOut("fast",function(){thisView.cell.row.resize();thisView.model.destroy()})}});panels.collection.widgets=Backbone.Collection.extend({model:panels.model.widget,initialize:function(){}});panels.model.cell=Backbone.Model.extend({widgets:{},row:null,defaults:{weight:0},initialize:function(){this.widgets=new panels.collection.widgets;this.on("destroy",this.onDestroy,this)},onDestroy:function(){_.invoke(this.widgets.toArray(),"destroy");this.widgets.reset()},clone:function(row,cloneOptions){if(typeof row==="undefined"){row=this.row}cloneOptions=_.extend({cloneWidgets:true},cloneOptions);var clone=new this.constructor(this.attributes);clone.set("collection",row.cells,{silent:true});clone.row=row;if(cloneOptions.cloneWidgets){this.widgets.each(function(widget){clone.widgets.add(widget.clone(clone,cloneOptions),{silent:true})})}return clone}});panels.collection.cells=Backbone.Collection.extend({model:panels.cell,initialize:function(){this.on("add",this.onAddCell,this)},totalWeight:function(){var totalWeight=0;this.each(function(cell){totalWeight+=cell.get("weight")});return totalWeight}});panels.view.cell=Backbone.View.extend({template:_.template($("#siteorigin-panels-builder-cell").html().panelsProcessTemplate()),events:{"click .cell-wrapper":"handleCellClick","click .so-cell-actions a":"handleActionClick"},row:null,widgetSortable:null,initialize:function(){this.model.widgets.on("add",this.onAddWidget,this)},render:function(){var templateArgs={weight:this.model.get("weight"),totalWeight:this.row.model.cells.totalWeight()};this.setElement(this.template(templateArgs));this.$el.data("view",this);var thisView=this;this.model.widgets.each(function(widget){var widgetView=new panels.view.widget({model:widget});widgetView.cell=thisView;widgetView.render();widgetView.$el.appendTo(thisView.$(".widgets-container"))});this.initSortable();this.initResizable()},initSortable:function(){var cellView=this;var builderID=cellView.row.builder.$el.attr("id");this.widgetSortable=this.$el.find(".widgets-container").sortable({placeholder:"so-widget-sortable-highlight",connectWith:"#"+builderID+" .so-cells .cell .widgets-container",tolerance:"pointer",scroll:false,over:function(e,ui){cellView.row.builder.trigger("widget_sortable_move")},stop:function(e,ui){cellView.row.builder.addHistoryEntry("widget_moved");var widget=$(ui.item).data("view");var targetCell=$(ui.item).closest(".cell").data("view");widget.model.moveToCell(targetCell.model);widget.cell=targetCell;cellView.row.builder.sortCollections()},helper:function(e,el){var helper=el.clone().css({width:el.outerWidth(),"z-index":1e4,position:"fixed"}).addClass("widget-being-dragged").appendTo("body");if(el.outerWidth()>720){helper.animate({"margin-left":e.pageX-el.offset().left-480/2,width:480},"fast")}return helper}})},refreshSortable:function(){this.widgetSortable.sortable("refresh")},initResizable:function(){var handle=this.$(".resize-handle").css("position","absolute");var container=this.row.$el;var cellView=this;var previousCell;handle.draggable({axis:"x",containment:container,start:function(e,ui){previousCell=cellView.$el.prev().data("view");if(typeof previousCell==="undefined"){return false}var newCellClone=cellView.$el.clone().appendTo(ui.helper).css({position:"absolute",top:"0",width:cellView.$el.outerWidth(),left:5,height:cellView.$el.outerHeight()});newCellClone.find(".resize-handle").remove();var prevCellClone=previousCell.$el.clone().appendTo(ui.helper).css({position:"absolute",top:"0",width:previousCell.$el.outerWidth(),right:5,height:previousCell.$el.outerHeight()});prevCellClone.find(".resize-handle").remove();$(this).data({newCellClone:newCellClone,prevCellClone:prevCellClone})},drag:function(e,ui){var containerWidth=cellView.row.$el.width()+10;var ncw=cellView.model.get("weight")-(ui.position.left+handle.outerWidth()/2)/containerWidth;var pcw=previousCell.model.get("weight")+(ui.position.left+handle.outerWidth()/2)/containerWidth;$(this).data("newCellClone").css("width",containerWidth*ncw).find(".preview-cell-weight").html(Math.round(ncw*1e3)/10);$(this).data("prevCellClone").css("width",containerWidth*pcw).find(".preview-cell-weight").html(Math.round(pcw*1e3)/10)},stop:function(e,ui){$(this).data("newCellClone").remove();$(this).data("prevCellClone").remove();var containerWidth=cellView.row.$el.width()+10;var ncw=cellView.model.get("weight")-(ui.position.left+handle.outerWidth()/2)/containerWidth;var pcw=previousCell.model.get("weight")+(ui.position.left+handle.outerWidth()/2)/containerWidth;if(ncw>.02&&pcw>.02){cellView.row.builder.addHistoryEntry("cell_resized");cellView.model.set("weight",ncw);previousCell.model.set("weight",pcw);cellView.row.resize()}ui.helper.css("left",-handle.outerWidth()/2)}})},onAddWidget:function(widget,collection,options){options=_.extend({noAnimate:false},options);var view=new panels.view.widget({model:widget});view.cell=this;if(typeof widget.isDuplicate==="undefined"){widget.isDuplicate=false}view.render({loadForm:widget.isDuplicate});if(typeof options.at==="undefined"||collection.length<=1){view.$el.appendTo(this.$(".widgets-container"))}else{view.$el.insertAfter(this.$(".widgets-container .so-widget").eq(options.at-1))}if(options.noAnimate===false){view.visualCreate()}this.refreshSortable();this.row.resize()},handleActionClick:function(e){return false}});panels.model.row=Backbone.Model.extend({cells:{},builder:null,defaults:{style:{}},initialize:function(){this.cells=new panels.collection.cells;this.on("destroy",this.onDestroy,this)},setCells:function(cells){var thisModel=this;if(this.cells.length===0){_.each(cells,function(cellWeight){var cell=new panels.model.cell({weight:cellWeight,collection:thisModel.cells});cell.row=thisModel;thisModel.cells.add(cell)})}else{if(cells.length>this.cells.length){for(var i=this.cells.length;i<cells.length;i++){var cell=new panels.model.cell({weight:cells[cells.length+i],collection:thisModel.cells});cell.row=this;thisModel.cells.add(cell)}}else if(cells.length<this.cells.length){_.each(this.cells.slice(cells.length,this.cells.length),function(cell){cell.destroy()})}this.cells.each(function(cell,i){cell.set("weight",cells[i])})}this.reweightCells()},reweightCells:function(){var totalWeight=0;this.cells.each(function(cell){totalWeight+=cell.get("weight")});this.cells.each(function(cell){cell.set("weight",cell.get("weight")/totalWeight)});this.trigger("reweight_cells")},onDestroy:function(){_.invoke(this.cells.toArray(),"destroy");this.cells.reset()},clone:function(builder,cloneOptions){if(typeof builder==="undefined"){builder=this.builder}cloneOptions=_.extend({cloneCells:true},cloneOptions);var clone=new this.constructor(this.attributes);clone.set("collection",builder.rows,{silent:true});clone.builder=builder;if(cloneOptions.cloneCells){this.cells.each(function(cell){clone.cells.add(cell.clone(clone,cloneOptions),{silent:true})})}return clone}});panels.collection.rows=Backbone.Collection.extend({model:panels.model.row,empty:function(){var model;do{model=this.collection.first();if(!model){break}model.destroy()}while(true)}});panels.view.row=Backbone.View.extend({template:_.template($("#siteorigin-panels-builder-row").html().panelsProcessTemplate()),events:{"click .so-row-settings":"editSettingsHandler","click .so-row-duplicate":"duplicateHandler","click .so-row-delete":"confirmedDeleteHandler"},builder:null,dialog:null,initialize:function(){this.model.cells.on("add",this.handleCellAdd,this);this.model.cells.on("remove",this.handleCellRemove,this);this.model.on("reweight_cells",this.resize,this);this.model.on("destroy",this.onModelDestroy,this);this.model.on("visual_destroy",this.visualDestroyModel,this);var thisView=this;this.model.cells.each(function(cell){thisView.listenTo(cell.widgets,"add",thisView.resize)});this.model.cells.on("add",function(cell){thisView.listenTo(cell.widgets,"add",thisView.resize)},this)},render:function(){this.setElement(this.template());this.$el.data("view",this);var thisView=this;this.model.cells.each(function(cell){var cellView=new panels.view.cell({model:cell});cellView.row=thisView;cellView.render();cellView.$el.appendTo(thisView.$(".so-cells"))});this.builder.on("widget_sortable_move",this.resize,this);this.builder.on("builder_resize",this.resize,this);this.resize();return this},visualCreate:function(){this.$el.hide().fadeIn("fast")},resize:function(e){if(!this.$el.is(":visible")){return false}this.$el.find(".so-cells .cell-wrapper").css("min-height",0);var height=0;this.$el.find(".so-cells .cell").each(function(){height=Math.max(height,$(this).height());$(this).css("width",$(this).data("view").model.get("weight")*100+"%")});this.$el.find(".so-cells .cell-wrapper").css("min-height",Math.max(height,70))},onModelDestroy:function(){this.remove()},visualDestroyModel:function(){this.builder.addHistoryEntry("row_deleted");var thisView=this;this.$el.fadeOut("normal",function(){thisView.model.destroy();thisView.builder.model.refreshPanelsData();if(thisView.builder.liveEditor.displayed){thisView.builder.liveEditor.refreshWidgets()}})},duplicateHandler:function(){this.builder.addHistoryEntry("row_duplicated");var duplicateRow=this.model.clone(this.builder.model);this.builder.model.rows.add(duplicateRow,{at:this.builder.model.rows.indexOf(this.model)+1});return false},confirmedDeleteHandler:function(e){var $$=$(e.target);if($$.hasClass("dashicons")){$$=$$.parent()}if($$.hasClass("so-confirmed")){this.visualDestroyModel()}else{var originalText=$$.html();$$.addClass("so-confirmed").html('<span class="dashicons dashicons-yes"></span>'+panelsOptions.loc.dropdown_confirm);setTimeout(function(){$$.removeClass("so-confirmed").html(originalText)},2500)}return false},editSettingsHandler:function(){var dialog=this.builder.dialogs.row;if(this.dialog==null){this.dialog=new panels.dialog.row;this.dialog.setBuilder(this.builder).setRowModel(this.model)}this.dialog.openDialog();return false},deleteHandler:function(){this.model.destroy();return false},handleCellAdd:function(cell){var cellView=new panels.view.cell({model:cell});cellView.row=this;cellView.render();cellView.$el.appendTo(this.$(".so-cells"))},handleCellRemove:function(cell){this.$el.find(".so-cells > .cell").each(function(){var view=$(this).data("view");if(typeof view==="undefined"){return false}if(view.model.cid===cell.cid){view.remove()}})}});panels.model.builder=Backbone.Model.extend({rows:{},defaults:{data:{widgets:[],grids:[],grid_cells:[]}},initialize:function(){this.rows=new panels.collection.rows},addRow:function(weights,options){options=_.extend({noAnimate:false},options);var row=new panels.model.row({collection:this.rows});row.setCells(weights);row.builder=this;this.rows.add(row,options);return row},loadPanelsData:function(data){this.emptyRows();this.set("data",data,{silent:true});var cit=0;var rows=[];if(typeof data.grid_cells==="undefined"){return}var gi;for(var ci=0;ci<data.grid_cells.length;ci++){gi=parseInt(data.grid_cells[ci].grid);if(typeof rows[gi]==="undefined"){rows[gi]=[]}rows[gi].push(parseFloat(data.grid_cells[ci].weight))}var builderModel=this;_.each(rows,function(row,i){var newRow=builderModel.addRow(row,{noAnimate:true});if(typeof data.grids[i].style!=="undefined"){newRow.set("style",data.grids[i].style)}});if(typeof data.widgets==="undefined"){return}_.each(data.widgets,function(widgetData){try{var panels_info=null;if(typeof widgetData.panels_info!=="undefined"){panels_info=widgetData.panels_info;delete widgetData.panels_info}else{panels_info=widgetData.info;delete widgetData.info}var row=builderModel.rows.at(parseInt(panels_info.grid));var cell=row.cells.at(parseInt(panels_info.cell));var newWidget=new panels.model.widget({"class":panels_info.class,values:widgetData});if(typeof panels_info.style!=="undefined"){newWidget.set("style",panels_info.style)}newWidget.cell=cell;cell.widgets.add(newWidget,{noAnimate:true})}catch(err){}})},getPanelsData:function(){var data={widgets:[],grids:[],grid_cells:[]};var widgetId=0;this.rows.each(function(row,ri){row.cells.each(function(cell,ci){cell.widgets.each(function(widget,wi){var values=_.extend(_.clone(widget.get("values")),{panels_info:{"class":widget.get("class"),raw:widget.get("raw"),grid:ri,cell:ci,id:widgetId++,style:widget.get("style")}});data.widgets.push(values)});data.grid_cells.push({grid:ri,weight:cell.get("weight")})});data.grids.push({cells:row.cells.length,style:row.get("style")})});return data},refreshPanelsData:function(){var oldData=JSON.stringify(this.get("data"));var newData=this.getPanelsData();this.set("data",newData,{silent:true});if(JSON.stringify(newData)!==oldData){this.trigger("change");this.trigger("change:data")}},emptyRows:function(){_.invoke(this.rows.toArray(),"destroy");this.rows.reset();return this}});panels.view.builder=Backbone.View.extend({template:_.template($("#siteorigin-panels-builder").html().panelsProcessTemplate()),dialogs:{},rowsSortable:null,dataField:false,currentData:"",attachedToEditor:false,liveEditor:false,events:{"click .so-tool-button.so-widget-add":"displayAddWidgetDialog","click .so-tool-button.so-row-add":"displayAddRowDialog","click .so-tool-button.so-prebuilt-add":"displayAddPrebuiltDialog","click .so-tool-button.so-history":"displayHistoryDialog","click .so-tool-button.so-live-editor":"displayLiveEditor","click .so-cells .cell .cell-wrapper":"cellClickHandler"},rows:null,initialize:function(){var builder=this;this.dialogs={widgets:new panels.dialog.widgets,row:new panels.dialog.row,prebuilt:new panels.dialog.prebuilt};_.each(this.dialogs,function(p,i,d){d[i].setBuilder(builder)});this.dialogs.row.setRowDialogType("create");this.model.rows.on("add",this.onAddRow,this);$(window).resize(function(e){if(e.target===window){builder.trigger("builder_resize")}});this.model.on("change:data",this.storeModelData,this);this.on("content_change",this.handleContentChange,this);this.on("display_builder",this.handleDisplayBuilder,this);this.model.on("change:data",this.toggleWelcomeDisplay,this)},render:function(){this.$el.html(this.template());this.$el.attr("id","siteorigin-panels-builder-"+this.cid).addClass("so-builder-container");return this},attach:function(options){options=_.extend({container:false,dialog:false},options);if(options.dialog){this.dialog=new panels.dialog.builder;this.dialog.builder=this}else{this.$el.appendTo(options.container);this.metabox=options.container.closest(".postbox");this.initSortable()}return this},attachToEditor:function(){if(typeof this.metabox==="undefined"){return this}this.attachedToEditor=true;var metabox=this.metabox;var thisView=this;$("#wp-content-wrap .wp-editor-tabs").find(".wp-switch-editor").click(function(e){e.preventDefault();$("#wp-content-editor-container, #post-status-info").show();metabox.hide();$("#wp-content-wrap").removeClass("panels-active");$("#content-resize-handle").show();thisView.trigger("hide_builder")}).end().prepend($('<a id="content-panels" class="hide-if-no-js wp-switch-editor switch-panels">'+metabox.find("h3.hndle span").html()+"</a>").click(function(e){e.preventDefault();var $$=$(this);$("#wp-content-wrap, #post-status-info").hide();metabox.show().find("> .inside").show();$(window).resize();$(document).scroll();thisView.trigger("display_builder")}));if($("body").hasClass("branch-4-1")||$("body").hasClass("branch-4-2")){$("#wp-content-wrap .wp-editor-tabs #content-panels").appendTo($("#wp-content-wrap .wp-editor-tabs"))}metabox.find(".so-switch-to-standard").click(function(e){e.preventDefault();$("#wp-content-wrap, #post-status-info").show();metabox.hide();$(window).resize()}).show();metabox.insertAfter("#wp-content-wrap").hide().addClass("attached-to-editor");var data=this.model.get("data");if(typeof data.widgets!=="undefined"&&_.size(data.widgets)!==0){$("#content-panels.switch-panels").click()}var stickToolbar=function(){var toolbar=thisView.$(".so-builder-toolbar");var newTop=$(window).scrollTop()-thisView.$el.offset().top;if($("#wpadminbar").css("position")==="fixed"){newTop+=$("#wpadminbar").outerHeight()}newTop=Math.max(newTop,0);newTop=Math.min(newTop,thisView.$el.outerHeight()-toolbar.outerHeight()+20);toolbar.css("top",newTop);thisView.$el.css("padding-top",toolbar.outerHeight())};$(window).resize(stickToolbar);$(document).scroll(stickToolbar);stickToolbar();return this},initSortable:function(){var $el=this.$el;var builderView=this;this.rowsSortable=this.$el.find(".so-rows-container").sortable({appendTo:"#wpwrap",items:".so-row-container",handle:".so-row-move",tolerance:"pointer",scroll:false,stop:function(e){builderView.addHistoryEntry("row_moved");builderView.sortCollections()}})},refreshSortable:function(){if(this.rowsSortable!==null){this.rowsSortable.sortable("refresh")}},setDataField:function(field,options){options=_.extend({load:true},options);this.dataField=field;this.dataField.data("builder",this);if(options.load&&field.val()!==""){var data;try{data=JSON.parse(this.dataField.val())}catch(err){data=""}this.model.loadPanelsData(data);this.currentData=data;this.toggleWelcomeDisplay()}return this},storeModelData:function(){var data=JSON.stringify(this.model.get("data"));if($(this.dataField).val()!==data){$(this.dataField).val(data);this.trigger("content_change")}},onAddRow:function(row,collection,options){options=_.extend({noAnimate:false},options);var rowView=new panels.view.row({model:row});rowView.builder=this;rowView.render();if(typeof options.at==="undefined"||collection.length<=1){rowView.$el.appendTo(this.$(".so-rows-container"))}else{rowView.$el.insertAfter(this.$(".so-rows-container .so-row-container").eq(options.at-1))}if(options.noAnimate===false){rowView.visualCreate()}this.refreshSortable();rowView.resize()},displayAddWidgetDialog:function(){this.dialogs.widgets.openDialog();return false},displayAddRowDialog:function(){this.dialogs.row.openDialog();this.dialogs.row.setRowModel();return false},displayAddPrebuiltDialog:function(){this.dialogs.prebuilt.openDialog();return false},displayHistoryDialog:function(){this.dialogs.history.openDialog();return false},cellClickHandler:function(e){var cells=this.$el.find(".so-cells .cell").removeClass("cell-selected");$(e.target).parent().addClass("cell-selected")},getActiveCell:function(){if(this.$(".so-cells .cell").length===0){this.model.addRow([1],{noAnimate:true})}var activeCell=this.$(".so-cells .cell.cell-selected");if(!activeCell.length){activeCell=this.$(".so-cells .cell").first()}return activeCell.data("view").model},sortCollections:function(){var indexes={};this.$(".so-rows-container .so-row-container").each(function(ri,el){var $r=$(el);indexes[$r.data("view").model.cid]=ri;$r.find(".so-cells .cell").each(function(ci,el){var $c=$(el);$c.find(".so-widget").each(function(wi,el){var $w=$(el);indexes[$w.data("view").model.cid]=wi})})});this.model.rows.models=this.model.rows.sortBy(function(model){return indexes[model.cid]});this.model.rows.each(function(row){row.cells.each(function(cell){cell.widgets.models=cell.widgets.sortBy(function(widget){return indexes[widget.cid]})})});this.model.refreshPanelsData()},addLiveEditor:function(postId){if(typeof panels.view.liveEditor==="undefined"){return this}this.liveEditor=new panels.view.liveEditor;this.liveEditor.setPostId(postId);this.liveEditor.builder=this;if(this.liveEditor.hasPreviewUrl()){this.$(".so-builder-toolbar .so-live-editor").show()}return this},displayLiveEditor:function(){if(typeof this.liveEditor==="undefined"){return false}this.liveEditor.open();return false},addHistoryBrowser:function(){if(typeof panels.dialog.history==="undefined"){return this}this.dialogs.history=new panels.dialog.history;this.dialogs.history.builder=this;this.dialogs.history.entries.builder=this.model;this.dialogs.history.setRevertEntry(this.model);this.$(".so-builder-toolbar .so-history").show()},addHistoryEntry:function(text,data){if(typeof data==="undefined"){data=null}if(typeof this.dialogs.history!=="undefined"){this.dialogs.history.entries.addEntry(text,data)}},handleContentChange:function(){if(this.attachedToEditor&&this.$el.is(":visible")&&this.model.rows.length>0){$.post(ajaxurl,{action:"so_panels_builder_content",panels_data:JSON.stringify(this.model.getPanelsData()),post_id:$("#post_ID").val()},function(content){if(content==="")return;var t=$("<div />").html(content);t.find("div").each(function(){var c=$(this).contents();$(this).replaceWith(c)});content=t.html();if(typeof tinyMCE==="undefined"||tinyMCE.get("content")===null){$("#content").val(content)}else{tinyMCE.get("content").setContent(content)}$("#content").focusout()})}if(this.liveEditor!==false){this.liveEditor.refreshPreview()}},handleDisplayBuilder:function(){var editorContent="";var editor;if(typeof tinyMCE!=="undefined"){editor=tinyMCE.get("content")}if(editor!==null&&typeof editor.getContent==="function"){editorContent=editor.getContent()}else{editorContent=$("textarea#content").val()}if(_.isEmpty(this.model.get("data"))&&editorContent!==""){if(!confirm(panelsOptions.loc.confirm_use_builder)){return}var widgetClass="";if(typeof panelsOptions.widgets.WP_Widget_Black_Studio_TinyMCE!=="undefined"){widgetClass="WP_Widget_Black_Studio_TinyMCE"}else if(typeof panelsOptions.widgets.WP_Widget_Text!=="undefined"){widgetClass="WP_Widget_Text"}if(widgetClass===""){return}this.model.loadPanelsData({grid_cells:[{grid:0,weight:1}],grids:[{cells:1}],widgets:[{filter:"1",text:editorContent,title:"",type:"visual",panels_info:{"class":widgetClass,raw:false,grid:0,cell:0}}]});this.model.trigger("change");this.model.trigger("change:data")}},setDialogParents:function(text,dialog){_.each(this.dialogs,function(p,i,d){d[i].setParent(text,dialog)});this.on("add_dialog",function(newDialog){newDialog.setParent(text,dialog)},this)},toggleWelcomeDisplay:function(){if(this.model.rows.length){this.$(".so-panels-welcome-message").hide()}else{this.$(".so-panels-welcome-message").show()}}});panels.view.dialog=Backbone.View.extend({dialogTemplate:_.template($("#siteorigin-panels-dialog").html().panelsProcessTemplate()),dialogTabTemplate:_.template($("#siteorigin-panels-dialog-tab").html().panelsProcessTemplate()),tabbed:false,rendered:false,builder:false,className:"so-panels-dialog-wrapper",dialogClass:"",parentDialog:false,events:{"click .so-close":"closeDialog","click .so-nav.so-previous":"navToPrevious","click .so-nav.so-next":"navToNext"},initialize:function(){this.once("open_dialog",this.render);this.once("open_dialog",this.attach);this.once("open_dialog",this.setDialogClass);this.trigger("initialize_dialog",this);if(typeof this.initializeDialog!=="undefined"){this.initializeDialog()}},getNextDialog:function(){return null},getPrevDialog:function(){return null},setDialogClass:function(){if(this.dialogClass!==""){this.$(".so-panels-dialog").addClass(this.dialogClass)}},setBuilder:function(builder){this.builder=builder;builder.trigger("add_dialog",this,this.builder);return this},attach:function(){this.$el.appendTo("body");return this},parseDialogContent:function(html,args){args=_.extend({cid:this.cid},args);var c=$(_.template(html.panelsProcessTemplate())(args));var r={title:c.find(".title").html(),buttons:c.find(".buttons").html(),content:c.find(".content").html()};if(c.has(".left-sidebar")){r.left_sidebar=c.find(".left-sidebar").html()}if(c.has(".right-sidebar")){r.right_sidebar=c.find(".right-sidebar").html()}return r},renderDialog:function(attributes){this.$el.html(this.dialogTemplate(attributes)).hide();this.$el.data("view",this);this.$el.addClass("so-panels-dialog-wrapper");if(this.parentDialog!==false){var thisDialog=this;var dialogParent=$('<h3 class="so-parent-link"></h3>').html(this.parentDialog.text+'<div class="so-separator"></div>');dialogParent.click(function(e){e.preventDefault();thisDialog.closeDialog();thisDialog.parentDialog.openDialog()});this.$(".so-title-bar").prepend(dialogParent)}return this},initTabs:function(){var tabs=this.$el.find(".so-sidebar-tabs li a");if(tabs.length===0){return this}var thisDialog=this;tabs.click(function(e){e.preventDefault();var $$=$(this);thisDialog.$(".so-sidebar-tabs li").removeClass("tab-active");thisDialog.$(".so-content .so-content-tabs > *").hide();$$.parent().addClass("tab-active");var url=$$.attr("href");if(typeof url!=="undefined"&&url.charAt(0)==="#"){var tabName=url.split("#")[1];thisDialog.$(".so-content .so-content-tabs .tab-"+tabName).show()}thisDialog.trigger("tab_click",$$)});this.$el.find(".so-sidebar-tabs li a").first().click();return this},setupDialog:function(){this.openDialog();this.closeDialog()},refreshDialogNav:function(){this.$(".so-title-bar .so-nav").show().removeClass("so-disabled");var nextDialog=this.getNextDialog();var nextButton=this.$(".so-title-bar .so-next");var prevDialog=this.getPrevDialog();var prevButton=this.$(".so-title-bar .so-previous");if(nextDialog===null){nextButton.hide()}else if(nextDialog===false){nextButton.addClass("so-disabled")}if(prevDialog===null){prevButton.hide()}else if(prevDialog===false){prevButton.addClass("so-disabled")}},openDialog:function(){this.trigger("open_dialog");this.refreshDialogNav();this.bodyScrollTop=$("body").scrollTop();$("body").css({overflow:"hidden"});this.$el.show();this.trigger("open_dialog_complete")},closeDialog:function(e){this.trigger("close_dialog");if(typeof this.builder!=="undefined"){this.builder.model.refreshPanelsData()}this.$el.hide();if(!$(".so-panels-dialog-wrapper").is(":visible")){$("body").css({overflow:"auto"});$("body").scrollTop(this.bodyScrollTop)}this.trigger("close_dialog_complete");return false},navToPrevious:function(){this.closeDialog(null);var prev=this.getPrevDialog();if(prev!==null&&prev!==false){prev.openDialog()}},navToNext:function(){this.closeDialog(null);var next=this.getNextDialog();if(next!==null&&next!==false){next.openDialog()}},getFormValues:function(formSelector){if(typeof formSelector==="undefined"){formSelector=".so-content"}var $f=this.$(formSelector);var data={},parts;$f.find("[name]").each(function(){var $$=$(this);var name=/([A-Za-z_]+)\[(.*)\]/.exec($$.attr("name"));if(typeof name[2]==="undefined"){parts=$$.attr("name")}else{parts=name[2].split("][");parts.unshift(name[1])}parts=parts.map(function(e){if(!isNaN(parseFloat(e))&&isFinite(e)){return parseInt(e)}else{return e}});var sub=data;var fieldValue=null;var fieldType=typeof $$.attr("type")==="string"?$$.attr("type").toLowerCase():false;if(fieldType==="checkbox"){if($$.is(":checked")){fieldValue=$$.val()!==""?$$.val():true}else{fieldValue=null}}else if(fieldType==="radio"){if($$.is(":checked")){fieldValue=$$.val()}else{return}}else if($$.prop("tagName")==="TEXTAREA"&&$$.hasClass("wp-editor-area")){var editor=null;if(typeof tinyMCE!=="undefined"){editor=tinyMCE.get($$.attr("id"))}if(editor!==null&&typeof editor.getContent==="function"&&!editor.isHidden()){fieldValue=editor.getContent()}else{fieldValue=$$.val()}}else if($$.prop("tagName")==="SELECT"){var selected=$$.find("option:selected");if(selected.length===1){fieldValue=$$.find("option:selected").val()}else if(selected.length>1){fieldValue=_.map($$.find("option:selected"),function(n,i){return $(n).val()})}}else{fieldValue=$$.val()}if(typeof $$.data("panels-filter")!=="undefined"){switch($$.data("panels-filter")){case"json_parse":try{fieldValue=JSON.parse(fieldValue)}catch(err){fieldValue=""}break}}if(fieldValue!==null){for(var i=0;i<parts.length;i++){if(i===parts.length-1){sub[parts[i]]=fieldValue}else{if(typeof sub[parts[i]]==="undefined"){sub[parts[i]]={}}sub=sub[parts[i]]}}}});return data},setStatusMessage:function(message,loading){this.$(".so-toolbar .so-status").html(message);if(typeof loading!=="undefined"&&loading){this.$(".so-toolbar .so-status").addClass("so-panels-loading")
}},setParent:function(text,dialog){this.parentDialog={text:text,dialog:dialog}}});panels.dialog.builder=panels.view.dialog.extend({dialogClass:"so-panels-dialog-add-builder",render:function(){this.renderDialog(this.parseDialogContent($("#siteorigin-panels-dialog-builder").html(),{}));this.$(".so-content .siteorigin-panels-builder").append(this.builder.$el)},initializeDialog:function(){var thisView=this;this.once("open_dialog_complete",function(){thisView.builder.initSortable()});this.on("open_dialog_complete",function(){thisView.builder.trigger("builder_resize")})}});panels.dialog.widgets=panels.view.dialog.extend({builder:null,widgetTemplate:_.template($("#siteorigin-panels-dialog-widgets-widget").html().panelsProcessTemplate()),filter:{},dialogClass:"so-panels-dialog-add-widget",events:{"click .so-close":"closeDialog","click .widget-type":"widgetClickHandler","keyup .so-sidebar-search":"searchHandler"},initializeDialog:function(){this.on("open_dialog",function(){this.filter.search="";this.filterWidgets(this.filter)},this);this.on("open_dialog_complete",function(){this.$(".so-sidebar-search").val("").focus()});this.on("tab_click",this.tabClickHandler,this)},render:function(){this.renderDialog(this.parseDialogContent($("#siteorigin-panels-dialog-widgets").html(),{}));_.each(panelsOptions.widgets,function(widget){var $w=$(this.widgetTemplate({title:widget.title,description:widget.description}));if(typeof widget.icon==="undefined"){widget.icon="dashicons dashicons-admin-generic"}if(typeof widget.icon!=="undefined"){$('<span class="widget-icon" />').addClass(widget.icon).prependTo($w.find(".widget-type-wrapper"))}$w.data("class",widget.class).appendTo(this.$el.find(".widget-type-list"))},this);var tabs=this.$el.find(".so-sidebar-tabs");_.each(panelsOptions.widget_dialog_tabs,function(tab){var $t=$(this.dialogTabTemplate({title:tab.title})).data("filter",tab.filter).appendTo(tabs)},this);this.initTabs()},tabClickHandler:function($t){this.filter=$t.parent().data("filter");if(this.$el.find(".so-sidebar-search").val()!==""){this.filter.search=this.$el.find(".so-sidebar-search").val()}this.filterWidgets(this.filter);return false},searchHandler:function(e){this.filter.search=$(e.target).val();this.filterWidgets(this.filter)},filterWidgets:function(filter){if(typeof filter==="undefined"){filter={}}if(typeof filter.groups==="undefined"){filter.groups=""}this.$el.find(".widget-type-list .widget-type").each(function(){var $$=$(this),showWidget;var widgetClass=$$.data("class");var widgetData=typeof panelsOptions.widgets[widgetClass]!=="undefined"?panelsOptions.widgets[widgetClass]:null;if(filter.groups.length===0){showWidget=true}else if(widgetData!==null&&_.intersection(filter.groups,panelsOptions.widgets[widgetClass].groups).length){showWidget=true}else{showWidget=false}if(showWidget){if(typeof filter.search!=="undefined"&&filter.search!==""){if(widgetData.title.toLowerCase().indexOf(filter.search.toLowerCase())===-1){showWidget=false}}}if(showWidget){$$.show()}else{$$.hide()}})},widgetClickHandler:function(e){this.builder.addHistoryEntry("widget_added");var $w=$(e.currentTarget);var widget=new panels.model.widget({"class":$w.data("class")});widget.cell=this.builder.getActiveCell();widget.cell.widgets.add(widget);this.closeDialog()}});panels.dialog.widget=panels.view.dialog.extend({builder:null,sidebarWidgetTemplate:_.template($("#siteorigin-panels-dialog-widget-sidebar-widget").html().panelsProcessTemplate()),dialogClass:"so-panels-dialog-edit-widget",widgetView:false,events:{"click .so-close":"saveHistory","click .so-nav.so-previous":"navToPrevious","click .so-nav.so-next":"navToNext","click .so-toolbar .so-delete":"deleteHandler","click .so-toolbar .so-duplicate":"duplicateHandler"},initializeDialog:function(){this.model.on("destroy",this.remove,this)},render:function(){this.renderDialog(this.parseDialogContent($("#siteorigin-panels-dialog-widget").html(),{}));this.loadForm();if(typeof panelsOptions.widgets[this.model.get("class")]!=="undefined"){this.$(".so-title .widget-name").html(panelsOptions.widgets[this.model.get("class")].title)}else{this.$(".so-title .widget-name").html(panelsOptions.loc.missing_widget.title)}this.styles=new panels.view.styles;this.styles.model=this.model;this.styles.render("widget");this.styles.attach(this.$(".so-sidebar.so-right-sidebar"));this.styles.on("styles_loaded",function(){this.$(".so-sidebar.so-right-sidebar").removeClass("so-panels-loading")},this);this.$(".so-sidebar.so-right-sidebar").addClass("so-panels-loading")},getPrevDialog:function(){var widgets=this.builder.$(".so-cells .cell .so-widget");if(widgets.length<=1){return false}var currentIndex=widgets.index(this.widgetView.$el);if(currentIndex===0){return false}else{var widgetView=widgets.eq(currentIndex-1).data("view");if(typeof widgetView==="undefined"){return false}return widgetView.getEditDialog()}},getNextDialog:function(){var widgets=this.builder.$(".so-cells .cell .so-widget");if(widgets.length<=1){return false}var currentIndex=widgets.index(this.widgetView.$el);if(currentIndex===widgets.length-1){return false}else{var widgetView=widgets.eq(currentIndex+1).data("view");if(typeof widgetView==="undefined"){return false}return widgetView.getEditDialog()}},loadForm:function(){var thisView=this;this.$el.find(".so-content").addClass("so-panels-loading");var data={action:"so_panels_widget_form",widget:this.model.get("class"),instance:JSON.stringify(this.model.get("values")),raw:this.model.get("raw")};$.post(ajaxurl,data,function(result){var html=result.replace(/{\$id}/g,thisView.model.cid);thisView.$el.find(".so-content").removeClass("so-panels-loading").html(html);thisView.trigger("form_loaded",thisView);thisView.$el.find(".panel-dialog").trigger("panelsopen");thisView.on("close_dialog",thisView.saveWidget,thisView)},"html")},saveWidget:function(){var values=this.getFormValues();if(typeof values.widgets==="undefined"){return false}values=values.widgets;values=values[Object.keys(values)[0]];this.model.setValues(values);this.model.set("raw",true);if(this.styles.stylesLoaded){var style={};try{style=this.getFormValues(".so-sidebar .so-visual-styles").style}catch(e){}this.model.set("style",style)}},saveHistory:function(){this.builder.addHistoryEntry("widget_edited");this.closeDialog()},deleteHandler:function(){if(this.builder.liveEditor.displayed){this.model.destroy();this.builder.liveEditor.refreshWidgets()}else{this.model.trigger("visual_destroy")}this.closeDialog();return false},duplicateHandler:function(){this.model.trigger("user_duplicate");if(this.builder.liveEditor.displayed){this.builder.liveEditor.refreshWidgets()}this.closeDialog();return false}});panels.dialog.prebuilt=panels.view.dialog.extend({entryTemplate:_.template($("#siteorigin-panels-dialog-prebuilt-entry").html().panelsProcessTemplate()),builder:null,dialogClass:"so-panels-dialog-prebuilt-layouts",layoutCache:{},currentTab:false,events:{"click .so-close":"closeDialog","click .so-sidebar-tabs li a":"tabClickHandler","click .so-content .layout":"layoutClickHandler","keyup .so-sidebar-search":"searchHandler"},initializeDialog:function(){var thisView=this;this.on("open_dialog",function(){thisView.$('.so-sidebar-tabs li a[href="#prebuilt"]').click();thisView.$(".so-status").removeClass("so-panels-loading")})},render:function(){this.renderDialog(this.parseDialogContent($("#siteorigin-panels-dialog-prebuilt").html(),{}))},tabClickHandler:function(e){this.$(".so-sidebar-tabs li").removeClass("tab-active");var $$=$(e.target);var tab=$$.attr("href").split("#")[1];$$.parent().addClass("tab-active");var thisView=this;this.$(".so-content").empty();this.currentTab=tab;if(typeof this.layoutCache[tab]==="undefined"){this.$(".so-content").addClass("so-panels-loading");$.post(ajaxurl,{action:"so_panels_prebuilt_layouts",type:tab},function(layouts){thisView.layoutCache[tab]=layouts;thisView.$(".so-content").removeClass("so-panels-loading");thisView.displayLayouts(tab,layouts)})}else{thisView.displayLayouts(tab,this.layoutCache[tab])}return false},displayLayouts:function(type,layouts){var c=this.$(".so-content").empty();var query=this.$(".so-sidebar-search").val().toLowerCase();if(typeof layouts.error_message!=="undefined"){this.$(".so-content").append($('<div class="so-error-message">').html(layouts.error_message));return}for(var lid in layouts){if(type!=="prebuilt"&&lid===$("#post_ID").val()){continue}if(query!==""&&layouts[lid].name.toLowerCase().indexOf(query)===-1){continue}var $l=$(this.entryTemplate({name:layouts[lid].name,description:layouts[lid].description}));$l.appendTo(c).data({type:type,lid:lid})}},layoutClickHandler:function(e){var layout=$(e.target).closest(".layout");this.loadLayout(layout.data("type"),layout.data("lid"));return false},loadLayout:function(type,lid){var thisView=this;if(!confirm(panelsOptions.loc.prebuilt_confirm)){return false}this.setStatusMessage(panelsOptions.loc.prebuilt_loading,true);$.post(ajaxurl,{action:"so_panels_get_prebuilt_layout",type:type,lid:lid},function(layout){thisView.setStatusMessage("",false);thisView.builder.addHistoryEntry("prebuilt_loaded");thisView.builder.model.loadPanelsData(layout);thisView.closeDialog()})},searchHandler:function(){if(this.currentTab===false||typeof this.layoutCache[this.currentTab]==="undefined"){return false}this.displayLayouts(this.currentTab,this.layoutCache[this.currentTab])}});panels.dialog.row=panels.view.dialog.extend({cellPreviewTemplate:_.template($("#siteorigin-panels-dialog-row-cell-preview").html().panelsProcessTemplate()),events:{"click .so-close":"closeDialog","click .so-toolbar .so-save":"saveHandler","click .so-toolbar .so-insert":"insertHandler","click .so-toolbar .so-delete":"deleteHandler","click .so-toolbar .so-duplicate":"duplicateHandler","change .row-set-form > *":"setCellsFromForm","click .row-set-form button.set-row":"setCellsFromForm"},dialogClass:"so-panels-dialog-row-edit",styleType:"row",dialogType:"edit",row:{cells:[],style:{}},initializeDialog:function(){this.on("open_dialog",function(){if(typeof this.model!=="undefined"&&this.model.cells.length!==0){this.setRowModel(this.model)}else{this.setRowModel(null)}this.regenerateRowPreview()},this);this.row={cells:[.5,.5],style:{}}},setRowDialogType:function(dialogType){this.dialogType=dialogType},render:function(dialogType){this.renderDialog(this.parseDialogContent($("#siteorigin-panels-dialog-row").html(),{dialogType:this.dialogType}));if(this.dialogType==="edit"){this.styles=new panels.view.styles;this.styles.model=this.model;this.styles.render("row");this.styles.attach(this.$(".so-sidebar.so-right-sidebar"));this.styles.on("styles_loaded",function(){this.$(".so-sidebar.so-right-sidebar").removeClass("so-panels-loading")},this);this.$(".so-sidebar.so-right-sidebar").addClass("so-panels-loading")}if(typeof this.model!=="undefined"){this.$("input.so-row-field").val(this.model.cells.length)}var thisView=this;this.$("input.so-row-field").keyup(function(){$(this).trigger("change")});return this},setRowModel:function(model){this.model=model;if(this.model===null){return this}this.row={cells:this.model.cells.map(function(cell){return cell.get("weight")}),style:{}};this.$("input.so-row-field").val(this.model.cells.length);return this},regenerateRowPreview:function(){var thisDialog=this;var rowPreview=this.$(".row-preview");rowPreview.empty();var timeout;_.each(this.row.cells,function(cell,i){var newCell=$(this.cellPreviewTemplate({weight:cell}));rowPreview.append(newCell);var prevCell=newCell.prev();var handle;if(prevCell.length!==0){handle=$('<div class="resize-handle"></div>');handle.appendTo(newCell).dblclick(function(){var t=thisDialog.row.cells[i]+thisDialog.row.cells[i-1];thisDialog.row.cells[i]=thisDialog.row.cells[i-1]=t/2;thisDialog.scaleRowWidths()});handle.draggable({axis:"x",containment:rowPreview,start:function(e,ui){var newCellClone=newCell.clone().appendTo(ui.helper).css({position:"absolute",top:"0",width:newCell.outerWidth(),left:6,height:newCell.outerHeight()});newCellClone.find(".resize-handle").remove();var prevCellClone=prevCell.clone().appendTo(ui.helper).css({position:"absolute",top:"0",width:prevCell.outerWidth(),right:6,height:prevCell.outerHeight()});prevCellClone.find(".resize-handle").remove();$(this).data({newCellClone:newCellClone,prevCellClone:prevCellClone});newCell.find("> .preview-cell-in").css("visibility","hidden");prevCell.find("> .preview-cell-in").css("visibility","hidden")},drag:function(e,ui){var ncw=thisDialog.row.cells[i]-(ui.position.left+6)/rowPreview.width();var pcw=thisDialog.row.cells[i-1]+(ui.position.left+6)/rowPreview.width();var helperLeft=ui.helper.offset().left-rowPreview.offset().left-6;$(this).data("newCellClone").css("width",rowPreview.width()*ncw).find(".preview-cell-weight").html(Math.round(ncw*1e3)/10);$(this).data("prevCellClone").css("width",rowPreview.width()*pcw).find(".preview-cell-weight").html(Math.round(pcw*1e3)/10)},stop:function(e,ui){$(this).data("newCellClone").remove();$(this).data("prevCellClone").remove();newCell.find(".preview-cell-in").css("visibility","visible");prevCell.find(".preview-cell-in").css("visibility","visible");var offset=ui.position.left+6;var percent=offset/rowPreview.width();if(thisDialog.row.cells[i]-percent>.02&&thisDialog.row.cells[i-1]+percent>.02){thisDialog.row.cells[i]-=percent;thisDialog.row.cells[i-1]+=percent}thisDialog.scaleRowWidths();ui.helper.css("left",-6)}})}newCell.find(".preview-cell-weight").click(function(ci){thisDialog.$(".resize-handle").css("pointer-event","none").draggable("disable");rowPreview.find(".preview-cell-weight").each(function(){var $$=$(this).hide();$('<input type="text" class="preview-cell-weight-input no-user-interacted" />').val(parseFloat($$.html())).insertAfter($$).focus(function(){clearTimeout(timeout)}).keyup(function(e){if(e.keyCode!==9){$(this).removeClass("no-user-interacted")}if(e.keyCode===13){e.preventDefault();$(this).blur()}}).keydown(function(e){if(e.keyCode===9){e.preventDefault();var inputs=rowPreview.find(".preview-cell-weight-input");var i=inputs.index($(this));if(i===inputs.length-1){inputs.eq(0).focus().select()}else{inputs.eq(i+1).focus().select()}}}).blur(function(){rowPreview.find(".preview-cell-weight-input").each(function(i,el){if(isNaN(parseFloat($(el).val()))){$(el).val(Math.floor(thisDialog.row.cells[i]*1e3)/10)}});timeout=setTimeout(function(){if(rowPreview.find(".preview-cell-weight-input").length===0){return false}var rowWeights=[],rowChanged=[],changedSum=0,unchangedSum=0;rowPreview.find(".preview-cell-weight-input").each(function(i,el){var val=parseFloat($(el).val());if(isNaN(val)){val=1/thisDialog.row.cells.length}else{val=Math.round(val*10)/1e3}var changed=!$(el).hasClass("no-user-interacted");rowWeights.push(val);rowChanged.push(changed);if(changed){changedSum+=val}else{unchangedSum+=val}});if(changedSum>0&&unchangedSum>0&&1-changedSum>0){for(var i=0;i<rowWeights.length;i++){if(!rowChanged[i]){rowWeights[i]=rowWeights[i]/unchangedSum*(1-changedSum)}}}var sum=_.reduce(rowWeights,function(memo,num){return memo+num});rowWeights=rowWeights.map(function(w){return w/sum});if(Math.min.apply(Math,rowWeights)>.01){thisDialog.row.cells=rowWeights}rowPreview.find(".preview-cell").each(function(i,el){$(el).animate({width:Math.round(thisDialog.row.cells[i]*1e3)/10+"%"},250);$(el).find(".preview-cell-weight-input").val(Math.round(thisDialog.row.cells[i]*1e3)/10)});rowPreview.find(".preview-cell").css("overflow","visible");setTimeout(function(){thisDialog.regenerateRowPreview()},260)},100)}).click(function(){$(this).select()})});$(this).siblings(".preview-cell-weight-input").select()})},this)},scaleRowWidths:function(){var thisDialog=this;this.$(".row-preview .preview-cell").each(function(i,el){$(el).css("width",thisDialog.row.cells[i]*100+"%").find(".preview-cell-weight").html(Math.round(thisDialog.row.cells[i]*1e3)/10)})},setCellsFromForm:function(){var f={cells:parseInt(this.$el.find('.row-set-form input[name="cells"]').val()),ratio:parseFloat(this.$el.find('.row-set-form select[name="ratio"]').val()),direction:this.$el.find('.row-set-form select[name="ratio_direction"]').val()};var cells=[];if(isNaN(f.cells)||isNaN(f.ratio)){return false}var cellCountChanged=this.row.cells.length!==f.cells;if(f.cells<1){this.$el.find('.row-set-form input[name="cells"]').val(1);f.cells=1}else if(f.cells>20){this.$el.find('.row-set-form input[name="cells"]').val(20);f.cells=20}var currentWeight=1;for(var i=0;i<f.cells;i++){cells.push(currentWeight);currentWeight*=f.ratio}var totalRowWeight=_.reduce(cells,function(memo,weight){return memo+weight});cells=_.map(cells,function(cell){return cell/totalRowWeight});cells=_.filter(cells,function(cell){return cell>.01});if(f.direction==="left"){cells=cells.reverse()}this.row.cells=cells;if(cellCountChanged){this.regenerateRowPreview()}else{var thisDialog=this;this.$el.find(".preview-cell").each(function(i,el){$(el).animate({width:Math.round(thisDialog.row.cells[i]*1e3)/10+"%"},250);$(el).find(".preview-cell-weight").html(Math.round(thisDialog.row.cells[i]*1e3)/10)});this.$el.find(".preview-cell").css("overflow","visible");setTimeout(function(){thisDialog.regenerateRowPreview()},260)}this.$el.find(".row-set-form .so-button-row-set").removeClass("button-primary")},tabClickHandler:function($t){if($t.attr("href")==="#row-layout"){this.$(".so-panels-dialog").addClass("so-panels-dialog-has-right-sidebar")}else{this.$(".so-panels-dialog").removeClass("so-panels-dialog-has-right-sidebar")}},updateModel:function(){this.model.setCells(this.row.cells);if(typeof this.styles!=="undefined"&&this.styles.stylesLoaded){var style={};try{style=this.getFormValues(".so-sidebar .so-visual-styles").style}catch(e){}this.model.set("style",style)}},insertHandler:function(){this.builder.addHistoryEntry("row_added");this.model=new panels.model.row;this.updateModel();this.model.collection=this.builder.model.rows;this.builder.model.rows.add(this.model);this.closeDialog();return false},saveHandler:function(){this.builder.addHistoryEntry("row_edited");this.updateModel();this.closeDialog();return false},deleteHandler:function(){this.model.trigger("visual_destroy");this.closeDialog();return false},duplicateHandler:function(){this.builder.addHistoryEntry("row_duplicated");var duplicateRow=this.model.clone(this.builder.model);this.builder.model.rows.add(duplicateRow,{at:this.builder.model.rows.indexOf(this.model)+1});this.closeDialog();return false}});window.siteoriginPanels=panels})(jQuery,_,soPanelsOptions);jQuery(function($){var container=false,field=false,form=false,postId=false;if($("#siteorigin-panels-metabox").length&&$("form#post").length){container=$("#siteorigin-panels-metabox");field=$("#siteorigin-panels-metabox .siteorigin-panels-data-field");form=$("form#post");postId=$("#post_ID").val()}else if($("div#panels-home-page.wrap").length){var $$=$("div#panels-home-page.wrap");container=$$.find(".siteorigin-panels-builder");field=$$.find('input[name="panels_data"]');form=$$.find("form");postId=$("#panels-home-page").data("post-id")}if(container!==false){var panels=window.siteoriginPanels;var builderModel=new panels.model.builder;var builderView=new panels.view.builder({model:builderModel});builderView.render().attach({container:container}).setDataField(field).attachToEditor().addLiveEditor(postId).addHistoryBrowser();form.submit(function(e){builderModel.refreshPanelsData()});container.removeClass("so-panels-loading")}});(function($){var panels=window.siteoriginPanels;$.fn.soPanelsSetupBuilderWidget=function(){return this.each(function(){var $$=$(this);var widgetId=$$.closest("form").find(".widget-id").val();if(typeof widgetId!=="undefined"&&widgetId.indexOf("__i__")>-1){return}var builderModel=new panels.model.builder;var builderView=new panels.view.builder({model:builderModel});var dialog=$$.closest(".so-panels-dialog-wrapper").data("view");if(typeof dialog!=="undefined"){dialog.on("close_dialog",function(){builderModel.refreshPanelsData()});dialog.on("open_dialog_complete",function(){builderView.trigger("builder_resize")});dialog.model.on("destroy",function(){builderModel.emptyRows().destroy()});builderView.setDialogParents(soPanelsOptions.loc.layout_widget,dialog)}var isWidget=Boolean($$.closest(".widget-content").length);builderView.render().attach({container:$$,dialog:isWidget}).setDataField($$.find("input.panels-data"));if(isWidget){builderView.setDialogParents(soPanelsOptions.loc.layout_widget,builderView.dialog);$$.find(".siteorigin-panels-display-builder").click(function(){builderView.dialog.openDialog()})}else{$$.find(".siteorigin-panels-display-builder").parent().remove()}})};$(document).on("widget-added",function(e,widget){$(widget).find(".siteorigin-page-builder-widget").soPanelsSetupBuilderWidget()});$(function(){$(".siteorigin-page-builder-widget").soPanelsSetupBuilderWidget()})})(jQuery);